!function(a){function b(a){Object.defineProperty(this,a,{enumerable:!0,get:function(){return this[o][a]}})}function c(a){var b;if(a&&a.__esModule){b={};for(var c in a)Object.hasOwnProperty.call(a,c)&&(b[c]=a[c]);b.__useDefault&&delete b.__useDefault,b.__esModule=!0}else{if("[object Module]"===Object.prototype.toString.call(a)||"undefined"!=typeof System&&System.isModule&&System.isModule(a))return a;b={default:a,__useDefault:!0}}return new d(b)}function d(a){Object.defineProperty(this,o,{value:a}),Object.keys(a).forEach(b,this)}function e(a){return"@node/"===a.substr(0,6)?m(a,c(p(a.substr(6))),{}):n[a]}function f(a){var b=e(a);if(!b)throw new Error('Module "'+a+'" expected, but not contained in build.');if(b.module)return b.module;var c=b.linkRecord;return g(b,c),l(b,c,[]),b.module}function g(a,b){if(!b.depLoads){b.declare&&h(a,b),b.depLoads=[];for(var c=0;c<b.deps.length;c++){var d=e(b.deps[c]);b.depLoads.push(d),d.linkRecord&&g(d,d.linkRecord);var f=b.setters&&b.setters[c];f&&(f(d.module||d.linkRecord.moduleObj),d.importerSetters.push(f))}return a}}function h(b,c){var d=c.moduleObj,e=b.importerSetters,f=!1,g=c.declare.call(a,function(a,b){if(!f){if("object"==typeof a)for(var c in a)"__useDefault"!==c&&(d[c]=a[c]);else d[a]=b;f=!0;for(var g=0;g<e.length;g++)e[g](d);return f=!1,b}},{id:b.key});"function"!=typeof g?(c.setters=g.setters,c.execute=g.execute):(c.setters=[],c.execute=g)}function i(a,b,c){return n[a]={key:a,module:void 0,importerSetters:[],linkRecord:{deps:b,depLoads:void 0,declare:c,setters:void 0,execute:void 0,moduleObj:{}}}}function j(a,b,c,d){return n[a]={key:a,module:void 0,importerSetters:[],linkRecord:{deps:b,depLoads:void 0,declare:void 0,execute:d,executingRequire:c,moduleObj:{default:{},__useDefault:!0},setters:void 0}}}function k(a,b,c){return function(d){for(var e=0;e<a.length;e++)if(a[e]===d){var f,g=b[e],h=g.linkRecord;return f=h?-1===c.indexOf(g)?l(g,h,c):h.moduleObj:g.module,f.__useDefault?f.default:f}}}function l(b,c,e){if(e.push(b),b.module)return b.module;if(c.setters){for(var f=0;f<c.deps.length;f++){var g=c.depLoads[f],h=g.linkRecord;h&&-1===e.indexOf(g)&&l(g,h,h.setters?e:[])}c.execute.call(q)}else{var i={id:b.key},j=c.moduleObj;Object.defineProperty(i,"exports",{configurable:!0,set:function(a){j.default=a},get:function(){return j.default}});var m=k(c.deps,c.depLoads,e);if(!c.executingRequire)for(var f=0;f<c.deps.length;f++)m(c.deps[f]);var n=c.execute.call(a,m,j.default,i);if(void 0!==n?j.default=n:i.exports!==j.default&&(j.default=i.exports),j.default&&j.default.__esModule)for(var o in j.default)Object.hasOwnProperty.call(j.default,o)&&"default"!==o&&(j[o]=j.default[o])}var i=b.module=new d(c.moduleObj);if(!c.setters)for(var f=0;f<b.importerSetters.length;f++)b.importerSetters[f](i);return i}function m(a,b){return n[a]={key:a,module:b,importerSetters:[],linkRecord:void 0}}var n={},o="undefined"!=typeof Symbol?Symbol():"@@baseObject";d.prototype=Object.create(null),"undefined"!=typeof Symbol&&Symbol.toStringTag&&(d.prototype[Symbol.toStringTag]="Module");var p="undefined"!=typeof System&&System._nodeRequire||"undefined"!=typeof require&&void 0!==require.resolve&&"undefined"!=typeof process&&process.platform&&require,q={};return Object.freeze&&Object.freeze(q),function(a,b,e,g){return function(h){h(function(h){var k={_nodeRequire:p,register:i,registerDynamic:j,registry:{get:function(a){return n[a].module},set:m},newModule:function(a){return new d(a)}};m("@empty",new d({}));for(var l=0;l<b.length;l++)m(b[l],c(arguments[l],{}));g(k);var o=f(a[0]);if(a.length>1)for(var l=1;l<a.length;l++)f(a[l]);return e?o.default:(o instanceof d&&Object.defineProperty(o,"__esModule",{value:!0}),o)})}}}("undefined"!=typeof self?self:global)(["a"],[],!1,function(a){this.require,this.exports,this.module;a.registerDynamic("b",[],!0,function(a,b,c){var d=(this||self,Object);c.exports={create:d.create,getProto:d.getPrototypeOf,isEnum:{}.propertyIsEnumerable,getDesc:d.getOwnPropertyDescriptor,setDesc:d.defineProperty,setDescs:d.defineProperties,getKeys:d.keys,getNames:d.getOwnPropertyNames,getSymbols:d.getOwnPropertySymbols,each:[].forEach}}),a.registerDynamic("c",["b"],!0,function(a,b,c){var d=(this||self,a("b"));c.exports=function(a,b,c){return d.setDesc(a,b,c)}}),a.registerDynamic("d",["c"],!0,function(a,b,c){this||self;c.exports={default:a("c"),__esModule:!0}}),a.registerDynamic("e",["d"],!0,function(a,b,c){"use strict";var d=(this||self,a("d").default);b.default=function(){function a(a,b){for(var c=0;c<b.length;c++){var e=b[c];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),d(a,e.key,e)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),b.__esModule=!0}),a.registerDynamic("f",[],!0,function(a,b,c){"use strict";this||self;b.default=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},b.__esModule=!0}),a.register("a",["e","f"],function(a){var b,c,d,e,f;return{setters:[function(a){b=a.default},function(a){c=a.default}],execute:function(){"use strict";d=function(){function a(b){if(c(this,a),b=b||{},!b.workerLocation||!b.verovioLocation)return console.error("The VidaController must be initialized with both the 'workerLocation' and 'verovioLocation' parameters.");this.ticketID=0,this.tickets={},this.workerLocation=b.workerLocation,this.verovioLocation=b.verovioLocation,this.viewWorkers=[],this.views={}}return b(a,[{key:"register",value:function(a){var b=this,c=new Worker(this.workerLocation),d=this.viewWorkers.push(c)-1;return this.views[d]=a,c.onmessage=function(c){var d=c.data[0],e=c.data[1],f=c.data[2];"error"===d?(console.log("Error message from Verovio:",f),e&&delete b.tickets[e]):b.tickets[e]?(b.tickets[e].call(a,f),delete b.tickets[e]):console.log("Unexpected worker case:",c)},this.contactWorker("setVerovio",{location:this.verovioLocation},d),d}},{key:"contactWorker",value:function(a,b,c,d){this.tickets[this.ticketID]=d,this.viewWorkers[c].postMessage([a,this.ticketID,b]),this.ticketID++}},{key:"setMEIForViewIndex",value:function(a,b){this.views[a].refreshVerovio(b)}}]),a}(),a("VidaController",d),e=function(){function a(b){if(c(this,a),b=b||{},!b.controller||!b.parentElement)return console.error("All VidaView objects must be initialized with both the 'controller' and 'parentElement' parameters.");this.parentElement=b.parentElement,this.debug=b.debug,b.iconClasses=b.iconClasses||{},this.iconClasses={nextPage:b.iconClasses.nextPage||"",prevPage:b.iconClasses.prevPage||"",zoomIn:b.iconClasses.zoomIn||"",zoomOut:b.iconClasses.zoomOut||""},this.controller=b.controller,this.viewIndex=this.controller.register(this),this.bindListeners(),this.initializeLayoutAndWorker(),this.events=new f,this.publish=this.events.publish,this.subscribe=this.events.subscribe,this.unsubscribe=this.events.unsubscribe,this.resizeTimer,this.verovioSettings={pageHeight:100,pageWidth:100,inputFormat:"mei",scale:40,border:50,noLayout:0,ignoreLayout:1,adjustPageHeight:1},this.mei=void 0,this.verovioContent=void 0,this.systemData=[],this.currentSystem=0,this.totalSystems=0,this.clickedPage,this.draggingActive,this.highlightedCache=[],this.dragInfo={},b.mei&&this.refreshVerovio(b.mei)}return b(a,[{key:"destroy",value:function(){window.addEventListener("resize",this.boundResize),this.ui.svgOverlay.removeEventListener("scroll",this.boundSyncScroll),this.ui.nextPage.removeEventListener("click",this.boundGotoNext),this.ui.prevPage.removeEventListener("click",this.boundGotoPrev),this.ui.orientationToggle.removeEventListener("click",this.boundOrientationToggle),this.ui.zoomIn.removeEventListener("click",this.boundZoomIn),this.ui.zoomOut.removeEventListener("click",this.boundZoomOut),this.ui.svgOverlay.removeEventListener("click",this.boundObjectClick);for(var a=this.ui.svgOverlay.querySelectorAll(".note"),b=0;b<a.length;b++){var c=a[b];c.removeEventListener("mousedown",this.boundMouseDown),c.removeEventListener("touchstart",this.boundMouseDown)}document.removeEventListener("mousemove",this.boundMouseMove),document.removeEventListener("mouseup",this.boundMouseUp),document.removeEventListener("touchmove",this.boundMouseMove),document.removeEventListener("touchend",this.boundMouseUp),this.events.unsubscribeAll()}},{key:"initializeLayoutAndWorker",value:function(){this.ui={parentElement:this.parentElement,svgWrapper:void 0,svgOverlay:void 0,controls:void 0,popup:void 0},this.ui.parentElement.innerHTML='<div class="vida-wrapper"><div class="vida-toolbar"><div class="vida-page-controls vida-toolbar-block"><div class="vida-button vida-prev-page vida-direction-control '+this.iconClasses.prevPage+'"></div><div class="vida-button vida-next-page vida-direction-control '+this.iconClasses.nextPage+'"></div></div><div class="vida-orientation-controls vida-button vida-toolbar-block"><div class="vida-orientation-toggle">Toggle orientation</div></div><div class="vida-zoom-controls vida-toolbar-block"><span class="vida-button vida-zoom-in vida-zoom-control '+this.iconClasses.zoomIn+'"></span><span class="vida-button vida-zoom-out vida-zoom-control '+this.iconClasses.zoomOut+'"></span></div></div><div class="vida-svg-wrapper vida-svg-object" style="z-index: 1; position:absolute;"></div><div class="vida-svg-overlay vida-svg-object" style="z-index: 1; position:absolute;"></div><div class="vida-loading-popup"></div></div>',window.addEventListener("resize",this.boundResize),this.ui&&this.ui.svgOverlay&&this.destroy(),this.ui.svgWrapper=this.ui.parentElement.querySelector(".vida-svg-wrapper"),this.ui.svgOverlay=this.ui.parentElement.querySelector(".vida-svg-overlay"),this.ui.controls=this.ui.parentElement.querySelector(".vida-page-controls"),this.ui.popup=this.ui.parentElement.querySelector(".vida-loading-popup"),this.ui.nextPage=this.ui.parentElement.querySelector(".vida-next-page"),this.ui.prevPage=this.ui.parentElement.querySelector(".vida-prev-page"),this.ui.orientationToggle=this.ui.parentElement.querySelector(".vida-orientation-toggle"),this.ui.zoomIn=this.ui.parentElement.querySelector(".vida-zoom-in"),this.ui.zoomOut=this.ui.parentElement.querySelector(".vida-zoom-out"),this.ui.svgOverlay.addEventListener("scroll",this.boundSyncScroll),this.ui.nextPage.addEventListener("click",this.boundGotoNext),this.ui.prevPage.addEventListener("click",this.boundGotoPrev),this.ui.orientationToggle.addEventListener("click",this.boundOrientationToggle),this.ui.zoomIn.addEventListener("click",this.boundZoomIn),this.ui.zoomOut.addEventListener("click",this.boundZoomOut),this.updateDims()}},{key:"bindListeners",value:function(){var a=this;this.boundSyncScroll=function(b){return a.syncScroll(b)},this.boundGotoNext=function(b){return a.gotoNextPage(b)},this.boundGotoPrev=function(b){return a.gotoPrevPage(b)},this.boundOrientationToggle=function(b){return a.toggleOrientation(b)},this.boundZoomIn=function(b){return a.zoomIn(b)},this.boundZoomOut=function(b){return a.zoomOut(b)},this.boundObjectClick=function(b){return a.objectClickListener(b)},this.boundMouseDown=function(b){return a.mouseDownListener(b)},this.boundMouseMove=function(b){return a.mouseMoveListener(b)},this.boundMouseUp=function(b){return a.mouseUpListener(b)},this.boundResize=function(b){return a.resizeComponents(b)}}},{key:"getViewIndex",value:function(){return this.viewIndex}},{key:"contactWorker",value:function(a,b,c){this.controller.contactWorker(a,b,this.viewIndex,c)}},{key:"renderPage",value:function(a){var b=this.ui.svgWrapper.getBoundingClientRect().top;this.ui.parentElement.querySelector(".vida-system-wrapper[data-index='"+a.pageIndex+"']").innerHTML=a.svg;for(var c=this.ui.svgWrapper.querySelectorAll("g[class=system]"),d=0;d<c.length;d++)this.systemData[d]={topOffset:c[d].getBoundingClientRect().top-b-this.verovioSettings.border,id:c[d].id};this.totalSystems=this.systemData.length,a.createOverlay&&this.createOverlay(),this.verovioContent=this.ui.svgWrapper.innerHTML,this.ui.popup.remove(),this.reapplyHighlights(),this.updateNavIcons(),this.events.publish("PageRendered",[this.mei])}},{key:"initPopup",value:function(a){this.ui.popup.style.top=this.ui.parentElement.getBoundingClientRect().top+50,this.ui.popup.style.left=this.ui.parentElement.getBoundingClientRect().left+30,this.ui.popup.innerHTML=a,this.ui.popup.style.display="block"}},{key:"hidePopup",value:function(){this.ui.popup.innerHTML="",this.ui.popup.style.display="none"}},{key:"refreshVerovio",value:function(a){var b=this;a&&(this.mei=a),this.mei&&(this.ui.svgOverlay.innerHTML=this.ui.svgWrapper.innerHTML=this.verovioContent="",this.verovioSettings.pageHeight=Math.max(this.ui.svgWrapper.clientHeight*(100/this.verovioSettings.scale)-this.verovioSettings.border,100)>>0,this.verovioSettings.pageWidth=Math.max(this.ui.svgWrapper.clientWidth*(100/this.verovioSettings.scale)-this.verovioSettings.border,100)>>0,this.contactWorker("setOptions",{options:JSON.stringify(this.verovioSettings)}),this.contactWorker("loadData",{mei:this.mei+"\n"},function(a){for(var c=0;c<a.pageCount;c++)b.ui.svgWrapper.innerHTML+="<div class='vida-system-wrapper' data-index='"+c+"'></div>",b.contactWorker("renderPage",{pageIndex:c},b.renderPage)}))}},{key:"createOverlay",value:function(){this.ui.svgOverlay.innerHTML=this.ui.svgWrapper.innerHTML;var a,b=this.ui.svgOverlay.querySelectorAll("g");for(a=0;a<b.length;a++)b[a].style.strokeOpacity=0,b[a].style.fillOpacity=0;var c=this.ui.svgOverlay.querySelectorAll("path");for(a=0;a<c.length;a++)c[a].style.strokeOpacity=0,c[a].style.fillOpacity=0;delete this.ui.svgOverlay.querySelectorAll("text"),this.ui.svgOverlay.removeEventListener("click",this.boundObjectClick),this.ui.svgOverlay.addEventListener("click",this.boundObjectClick);var d=this.ui.svgOverlay.querySelectorAll(".note");for(a=0;a<d.length;a++){var e=d[a];e.removeEventListener("mousedown",this.boundMouseDown),e.removeEventListener("touchstart",this.boundMouseDown),e.addEventListener("mousedown",this.boundMouseDown),e.addEventListener("touchstart",this.boundMouseDown)}}},{key:"updateNavIcons",value:function(){this.verovioSettings.noLayout||this.currentSystem===this.totalSystems-1?this.ui.nextPage.style.visibility="hidden":this.ui.nextPage.style.visibility="visible",this.verovioSettings.noLayout||0===this.currentSystem?this.ui.prevPage.style.visibility="hidden":this.ui.prevPage.style.visibility="visible"}},{key:"updateZoomIcons",value:function(){100==this.verovioSettings.scale?this.ui.zoomIn.style.visibility="hidden":this.ui.zoomIn.style.visibility="visible",10==this.verovioSettings.scale?this.ui.zoomOut.style.visibility="hidden":this.ui.zoomOut.style.visibility="visible"}},{key:"scrollToObject",value:function(a){var b=this.ui.svgOverlay.querySelector("#"+a).closest(".vida-svg-wrapper");scrollToPage(b.parentNode.children.indexOf(b))}},{key:"scrollToPage",value:function(a){var b=this.systemData[a].topOffset;this.ui.svgOverlay.scrollTop=b,this.updateNavIcons()}},{key:"resizeComponents",value:function(){this.updateDims(),clearTimeout(this.resizeTimer);var a=this;this.resizeTimer=setTimeout(function(){a.refreshVerovio()},200)}},{key:"updateDims",value:function(){this.ui.svgOverlay.style.height=this.ui.svgWrapper.style.height=this.ui.parentElement.clientHeight-this.ui.controls.clientHeight,this.ui.svgOverlay.style.top=this.ui.svgWrapper.style.top=this.ui.controls.clientHeight,this.ui.svgOverlay.style.width=this.ui.svgWrapper.style.width=this.ui.parentElement.clientWidth}},{key:"syncScroll",value:function(a){var b=this.ui.svgWrapper.scrollTop=a.target.scrollTop;if(this.ui.svgWrapper.scrollLeft=this.ui.svgOverlay.scrollLeft,!this.verovioSettings.noLayout)for(var c=0;c<this.systemData.length;c++)if(b<=this.systemData[c].topOffset+25){this.currentSystem=c;break}this.updateNavIcons()}},{key:"gotoNextPage",value:function(){this.currentSystem<this.totalSystems-1&&this.scrollToPage(this.currentSystem+1)}},{key:"gotoPrevPage",value:function(){this.currentSystem>0&&this.scrollToPage(this.currentSystem-1)}},{key:"toggleOrientation",value:function(){var a=this.ui.parentElement.getElementsByClassName("vida-direction-control");if(1===this.verovioSettings.noLayout){this.verovioSettings.noLayout=0;for(var b=0;b<a.length;b++)a[b].style.visibility="visible"}else{this.verovioSettings.noLayout=1;for(var b=0;b<a.length;b++)a[b].style.visibility="hidden"}this.refreshVerovio()}},{key:"zoomIn",value:function(){this.verovioSettings.scale<=100&&(this.verovioSettings.scale+=10,this.refreshVerovio()),this.updateZoomIcons()}},{key:"zoomOut",value:function(){this.verovioSettings.scale>10&&(this.verovioSettings.scale-=10,this.refreshVerovio()),this.updateZoomIcons()}},{key:"objectClickListener",value:function(a){var b=a.target.closest(".measure");b&&this.publish("ObjectClicked",[a.target,b]),a.stopPropagation()}},{key:"mouseDownListener",value:function(a){for(var b=a.target,c=b.parentNode.attributes.id.value,d=b.closest(".system").attributes.id.value,e=0;e<this.systemData.length;e++)if(this.systemData[e].id==d){this.clickedPage=e;break}this.resetHighlights(),this.activateHighlight(c);var f=b.closest("svg"),g=f.parentNode.closest("svg"),h=f.getAttribute("viewBox").split(" "),i=parseInt(h[3]),j=parseInt(g.getAttribute("height")),k=i/j;this.dragInfo.x=b.getAttribute("x")>>0,this.dragInfo.svgY=b.getAttribute("y")>>0,this.dragInfo.initY=a.pageY,this.dragInfo.pixPerPix=k,document.addEventListener("mousemove",this.boundMouseMove),document.addEventListener("mouseup",this.boundMouseUp),document.addEventListener("touchmove",this.boundMouseMove),document.addEventListener("touchend",this.boundMouseUp),this.draggingActive=!1}},{key:"mouseMoveListener",value:function(a){for(var b=(a.pageY-this.dragInfo.initY)*this.dragInfo.pixPerPix,c=0;c<this.highlightedCache.length;c++)this.ui.svgOverlay.querySelector("#"+this.highlightedCache[c]).setAttribute("transform","translate(0, "+b+")");this.draggingActive=!0,a.preventDefault()}},{key:"mouseUpListener",value:function(a){document.removeEventListener("mousemove",this.boundMouseMove),document.removeEventListener("mouseup",this.boundMouseUp),document.removeEventListener("touchmove",this.boundMouseMove),document.removeEventListener("touchend",this.boundMouseUp),this.draggingActive&&this.commitChanges(a.pageY)}},{key:"commitChanges",value:function(a){for(var b=0;b<this.highlightedCache.length;b++){var c=this.highlightedCache[b],d=this.ui.svgOverlay.querySelector("#"+c),e=this.dragInfo.svgY+(a-this.dragInfo.initY)*this.dragInfo.pixPerPix;d.style.transform="translate("+[0,e]+")",d.style.fill="#000",d.style.stroke="#000";var f=JSON.stringify({action:"drag",param:{elementId:c,x:parseInt(this.dragInfo.x),y:parseInt(e)}});this.contactWorker("edit",{action:f,pageIndex:this.clickedPage},this.renderPage),this.draggingActive&&this.removeHighlight(c)}this.draggingActive&&(this.contactWorker("renderPage",{pageIndex:this.clickedPage},this.renderPage),this.draggingActive=!1,this.dragInfo={})}},{key:"activateHighlight",value:function(a){this.highlightedCache.indexOf(a)>-1||(this.highlightedCache.push(a),this.reapplyHighlights(),this.ui.svgWrapper.querySelector("#"+a).setAttribute("style","fill-opacity: 0.0; stroke-opacity: 0.0;"))}},{key:"reapplyHighlights",value:function(){for(var a=0;a<this.highlightedCache.length;a++){this.ui.svgOverlay.querySelector("#"+this.highlightedCache[a]).setAttribute("style","fill: #ff0000; stroke: #ff00000; fill-opacity: 1.0; stroke-opacity: 1.0;")}}},{key:"removeHighlight",value:function(a){var b=this.highlightedCache.indexOf(a);if(b!==-1){var c=this.highlightedCache.splice(b,1);this.ui.svgWrapper.querySelector("#"+a).setAttribute("style","fill-opacity: 1.0; stroke-opacity: 1.0;"),this.ui.svgOverlay.querySelector("#"+c).setAttribute("style","fill: #000000; stroke: #0000000; fill-opacity: 0.0; stroke-opacity: 0.0;")}}},{key:"resetHighlights",value:function(){for(;this.highlightedCache[0];)this.removeHighlight(this.highlightedCache[0])}}]),a}(),a("VidaView",e),f=function a(){c(this,a);var b={};this.publish=function(a,c,d){if(b[a])for(var e=b[a],f=e.length;f--;)e[f].apply(d||this,c||[])},this.subscribe=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},this.unsubscribe=function(a,c){var d=a[0];if(b[d])for(var e=b[d].length;e--;)if(b[d][e]===a[1])return b[d].splice(e,1),c&&delete b[d],!0;return!1},this.unsubscribeAll=function(){b={}}}}}})})(function(a){"function"==typeof define&&define.amd?define([],a):"object"==typeof module&&module.exports&&"function"==typeof require?module.exports=a():a()});